<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">
    <service verb="consume" noun="AllArtifactLogs">
        <in-parameters>
            <parameter name="sinceDate" type="Timestamp"/>
            <parameter name="jobName"/>
        </in-parameters>
        <actions>
            <if condition="!jobName &amp;&amp; !sinceDate">
                <return error="true" message="Either jobName or sinceDate input parameters are required"/>
            </if>

            <if condition="!sinceDate">
                <entity-find-one entity-name="moqui.service.job.ServiceJobParameter" value-field="lastRunParam">
                    <field-map field-name="parameterName" value="lastRunTime"/>
                </entity-find-one>
                <set field="sinceDate" from="lastRunParam?.parameterValue"/>
            </if>

            <entity-find entity-name="co.hotwax.alc.ArtifactLog" list="artifactLogList">
                <econdition field-name="lastUpdatedStamp" from="sinceDate" operator="greater" ignore-if-empty="true"/>
            </entity-find>
            <set field="nowDate" from="ec.user.nowTimestamp"/>

            <iterate list="artifactLogList" entry="artifactLogValue">
                <log message="================= ${artifactLogValue}"/>
                <service-call name="co.hotwax.alc.ArtifactLifeCycleServices.create#ArtifactLogIndex" in-map="[artifactLogValue:artifactLogValue]"/>
            </iterate>

            <if condition="jobName != null &amp;&amp; !jobName.isEmpty()">
                <entity-make-value entity-name="moqui.service.job.ServiceJobParameter" value-field="updateLastRunParam" map="lastRunParam"/>
                <set field="updateLastRunParam.parameterValue" from="nowDate"/>
                <entity-update value-field="updateLastRunParam"/>
            </if>

            <return message="All Artifact Logs are indexed that are updated after Datetime: ${sinceDate}"/>
            <!--            <log message="sinceDate:${sinceDate}\njobName:${jobName}\n\nlist:${artifactLogList}"/>-->
        </actions>
    </service>

    <service verb="create" noun="ArtifactLogIndex">
        <in-parameters>
            <parameter name="artifactEventId"/>
            <parameter name="artifactLogValue" type="Map"/>
        </in-parameters>
        <actions>
            <if condition="artifactEventId != null &amp;&amp; !artifactEventId.isEmpty()">
                <entity-find-one entity-name="co.hotwax.alc.ArtifactLog" value-field="artifactLogValue"/>
            </if>

            <if condition="artifactLogValue == null"><return error="true" message="Artifact Log is not found"/></if>

            <set field="mountPoint" value="runtime://${System.getProperty('alc_sftp_mount_point')}"/>
            <set field="contentType" from="ec.resource.getContentType(artifactLogValue.logFilePath)"/>
            <set field="contentStream" from="ec.resource.getLocationReference(mountPoint+artifactLogValue.logFilePath).openStream()"/>

            <script><![CDATA[
                import org.moqui.impl.context.ContextJavaUtil
                import com.fasterxml.jackson.databind.JsonNode
                import org.apache.commons.csv.*
                contentObject = null

                if (contentType == "application/json") {
                    JsonNode contentRootNode = ContextJavaUtil.jacksonMapper.readTree(contentStream)
                    if (contentRootNode.isArray()) {
                        contentObject = contentRootNode.asList()
                    }
                    if (contentRootNode.isObject()) {
                        contentObject = contentRootNode.asType(Object.class)
                    }
                } else if (contentType == "text/csv") {
                    CSVParser csvParser = CSVFormat.DEFAULT.builder().setEscape((char)'\\').build().parse(new InputStreamReader(contentStream))
                    Map<String, Integer> headerMap = [:]
                    contentObject = []

                    Iterator<CSVRecord> iterator = csvParser.iterator()
                    CSVRecord headerRecord = iterator.next()
                    for (int i = 0; i < headerRecord.size(); i++) headerMap.put(headerRecord.get(i), i)

                    while (iterator.hasNext()) {
                        CSVRecord record = iterator.next()
                        valueMap = [:]

                        for (Map.Entry<String, Integer> field in headerMap) {
                            fieldValue = record.get(field.value)
                            if (fieldValue == null) continue
                            valueMap.put(field.key, fieldValue.isEmpty() ? null : fieldValue)
                        }
                        contentObject.add(valueMap)
                    }
                } else {
                    ec.message.addError("FileType is not Supported")
                    return
                }

                indexMap = [
                    artifactEventId: artifactLogValue.artifactEventId,
                    artifactLogId: artifactLogValue.artifactLogId,
                    artifactLogTypeId: artifactLogValue.artifactLogTypeId,
                    artifactLogIdTypeId: artifactLogValue.artifactLogIdTypeId,
                    artifactLogIdSystem: artifactLogValue.artifactLogIdSystem,
                    fromSystem: artifactLogValue.fromSystem,
                    toSystem: artifactLogValue.toSystem,
                    logOriginPath: artifactLogValue.logOriginPath,
                    logFilePath: artifactLogValue.logFilePath,
                    content: contentObject
                ]
                ]]>
            </script>

            <entity-make-value entity-name="co.hotwax.alc.ArtifactLogIndex" value-field="artifactLogIndex" map="indexMap"/>
            <entity-create value-field="artifactLogIndex"/>
        </actions>
    </service>
</services>